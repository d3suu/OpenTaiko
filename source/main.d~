import std.stdio;
import std.process;
import std.conv;
import std.file;
import std.string;
import std.ascii;

import drums;
import map_gen;

import derelict.util.exception : ShouldThrow;
import derelict.sdl2.sdl;

ShouldThrow myMissingSymCB( string symbolName ) {
    /*if( symbolName == "SDL_QueueAudio" )
    {
        return ShouldThrow.No;
    }
    else
    {
        return ShouldThrow.Yes;
    }*/
    return ShouldThrow.No;
}

SDL_Window *window;
SDL_Renderer *renderer;

Performance performance;

int frame;

void render() {

    int hitType = 3;
    SDL_Event event;
    while (SDL_PollEvent(&event) == 1) {
	int buttonPressed = -1;
	if (event.type == SDL_KEYDOWN) {
	    switch (event.key.keysym.sym) {
	    case SDLK_f:
		buttonPressed = 0;
		break;
		
	    case SDLK_j:
		buttonPressed = 0;
		break;

	    case SDLK_d:
		buttonPressed = 1;
		break;

	    case SDLK_k:
		buttonPressed = 1;
		break;

	    default:
		break;
	    }
	    if (buttonPressed == 0 || buttonPressed == 1) {
		hitType = performance.hit(buttonPressed, frame * 17);
		//if (buttonPressed == 0) {
		    //execute(["beep", "-l", "25", "-f", "500"]);
		//} else {
		    //execute(["beep", "-l", "25", "-f", "1000"]);
		//}
	    }
	}
    }
    
    SDL_SetRenderDrawColor(renderer, 40, 40, 40, 255);
    SDL_RenderClear(renderer);
    SDL_SetRenderDrawColor(renderer, 20, 20, 20, 255);
    SDL_Rect rectz = {0, 200, 65, 65};
    SDL_RenderFillRect(renderer, &rectz);
    foreach (Drum drum ; performance.drums) {
	int drawCoord = to!int(drum.position - (frame * 17));
	SDL_SetRenderDrawColor(renderer, 255, 255, 255, 255);
	SDL_Rect rect = {drawCoord - 3, 197, 56, 56};
	SDL_RenderFillRect(renderer, &rect);
	if (drum.color() == 0) { // Red drum
	    SDL_SetRenderDrawColor(renderer, 255, 0, 0, 255);
	} else if (drum.color() == 1) { // Blue drum
	    SDL_SetRenderDrawColor(renderer, 70, 70, 255, 255);
	} else {
	    SDL_SetRenderDrawColor(renderer, 0, 0, 0, 0);
	}
	SDL_Rect rectx = {drawCoord, 200, 50, 50};
	SDL_RenderFillRect(renderer, &rectx);
    }

    if (hitType != 3 || performance.checkTardiness(frame * 17)) {
	if (hitType == 0) {
	    SDL_SetRenderDrawColor(renderer, 255, 236, 0, 255);
	} else if (hitType == 1) {
	    SDL_SetRenderDrawColor(renderer, 247, 247, 247, 255);
	} else {
	    SDL_SetRenderDrawColor(renderer, 242, 0, 0, 255);
	}
	SDL_Rect rect = {0, 150, 30, 30};
	SDL_RenderFillRect(renderer, &rect);
    }
    
    SDL_RenderPresent(renderer);
    SDL_Delay(16); // aim for around 60FPS
    frame++;

}

void main(string[] args) {

    DerelictSDL2.missingSymbolCallback = &myMissingSymCB;
    
    try {
	DerelictSDL2.load();
    } catch (Exception SharedLibLoadException) {
	writeln(SharedLibLoadException.toString());
    }
    
    SDL_Init(SDL_INIT_VIDEO);

    write("Enter desired BPM value (and press ENTER): ");
    int bpm;
    try {
	bpm = to!int(removechars(stdin.readln(), std.ascii.newline));
    } catch (Exception ConvException) {
	writeln("You dip, that's not a number, I've set the BPM to 1337 for you instead so good luck playing the game now");
	bpm = 1337;
    }
    string mapString = to!string(std.file.read("map.conf"));
    performance = new Performance(mapString, bpm);

    writeln("Game will start in 5");
    SDL_Delay(1000);
    writeln("4");
    SDL_Delay(1000);
    writeln("3");
    SDL_Delay(1000);
    writeln("2");
    SDL_Delay(1000);
    writeln("1");
    SDL_Delay(1000);

    window = SDL_CreateWindow("test",
			      SDL_WINDOWPOS_UNDEFINED,
			      SDL_WINDOWPOS_UNDEFINED,
			      800,
			      600,
			      0);
    renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_ACCELERATED);
    SDL_SetRenderDrawColor(renderer, 0, 0, 0, 255);
    SDL_RenderClear(renderer);
    
    render();
    while (frame * 17 < performance.drums[performance.drums.length - 1].position) {
	render();
    }
    SDL_Delay(2000);
    writeln("Results:\n"
	    ~ "Good: " ~ to!string(performance.score.good)
	    ~ "\nOK: " ~ to!string(performance.score.ok)
	    ~ "\nBad/Miss: " ~ to!string(performance.score.bad)
	    ~ "\nScore: " ~ to!string(performance.calculateScore()));

    SDL_DestroyRenderer(renderer);
    SDL_DestroyWindow(window);

    writeln("Done.");

    SDL_Quit();
}
